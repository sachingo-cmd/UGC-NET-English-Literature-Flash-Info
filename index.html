<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UGC NET English Literature Flash Info</title>
  <style>
    :root {
      --dark-red: #b8483c;
      --mustard: #b8a245;
      --charcoal: #3c393e;
      --sage: #a6bd9e;
      --brown: #9c705d;
      --background: #f8f7f3;
      --text-color: #333333;
      --button-text-light: #ffffff;
      --highlight-red: #d22;

      --bg-light: #f8f7f3;
      --txt-light: #333333;
      --bg-dark: #1a1a1a;
      --txt-dark: #ddd;
      --dark-red-dark: #a6342b;
      --mustard-dark: #ab9937;
      --charcoal-dark: #979797;
      --sage-dark: #789178;
      --brown-dark: #754f41;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 1rem auto;
      background-color: var(--background);
      color: var(--text-color);
      padding: 1rem;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    body.dark {
      background-color: var(--bg-dark);
      color: var(--txt-dark);
    }
    h1 {
      color: var(--dark-red);
      font-weight: bold;
      text-align: center;
      margin-bottom: 1rem;
      text-shadow: 1px 1px 2px rgba(200, 200, 200, 0.6);
      transition: color 0.3s ease;
    }
    body.dark h1 {
      color: var(--dark-red-dark);
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--mustard);
      user-select: none;
      transition: color 0.3s ease;
    }
    body.dark label {
      color: var(--mustard-dark);
    }
    select, button, #searchInput {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: 2px solid var(--sage);
      border-radius: 6px;
      margin: 0.5rem 0 1rem 0;
      outline: none;
      font-weight: 600;
      user-select: none;
      width: 100%;
      box-sizing: border-box;
      cursor: pointer;
      transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
      background-color: #fff;
      color: var(--text-color);
    }
    body.dark select, body.dark button, body.dark #searchInput {
      border-color: var(--sage-dark);
      background-color: #222;
      color: var(--txt-dark);
    }
    select:focus, #searchInput:focus {
      border-color: var(--mustard);
      box-shadow: 0 0 5px var(--mustard);
    }
    button {
      background-color: var(--mustard);
      color: var(--button-text-light);
      border-color: var(--mustard);
    }
    button:disabled {
      background-color: #ccc;
      border-color: #ccc;
      cursor: not-allowed;
      color: #666;
    }
    button:hover:not(:disabled) {
      background-color: var(--dark-red);
      border-color: var(--dark-red);
    }
    body.dark button {
      background-color: var(--mustard-dark);
      color: var(--button-text-light);
      border-color: var(--mustard-dark);
    }
    body.dark button:hover:not(:disabled) {
      background-color: var(--dark-red-dark);
      border-color: var(--dark-red-dark);
    }
    #preview {
      font-size: 0.85rem;
      color: #555;
      border-bottom: 1px solid var(--sage);
      margin-bottom: 0.6rem;
      padding-bottom: 0.3rem;
      font-family: monospace, monospace;
      white-space: pre-wrap;
      user-select: text;
      max-height: 70px;
      overflow: auto;
      transition: color 0.3s ease, border-color 0.3s ease;
    }
    body.dark #preview {
      color: var(--charcoal-dark);
      border-color: var(--sage-dark);
    }
    #content {
      background-color: var(--sage);
      border-radius: 8px;
      padding: 1rem 1.5rem 1.5rem 1.5rem;
      min-height: 250px;
      line-height: 1.5;
      color: var(--charcoal);
      font-size: 1rem;
      box-shadow: 0 4px 8px rgba(60, 57, 62, 0.15);
      overflow-y: auto;
      max-height: 430px;
      user-select: text;
      position: relative;
      transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
    }
    body.dark #content {
      background-color: #374c38;
      color: var(--charcoal-dark);
      box-shadow: 0 4px 8px rgba(120, 120, 120, 0.3);
    }
    h2 {
      color: var(--dark-red);
      margin-top: 0;
      margin-bottom: 0.5rem;
      font-weight: 700;
      transition: color 0.3s ease;
    }
    body.dark h2 {
      color: var(--dark-red-dark);
    }
    p {
      margin-bottom: 1rem;
      white-space: pre-wrap;
    }
    img.thumb {
      max-height: 150px;
      display: block;
      margin: 0.25rem 0 1.0rem 0;
      border-radius: 6px;
      border: 1px solid var(--brown);
      box-shadow: 1px 1px 4px #8884;
      max-width: 100%;
      height: auto;
      transition: border-color 0.3s ease;
    }
    body.dark img.thumb {
      border-color: var(--brown-dark);
    }
    a {
      color: var(--dark-red);
      font-weight: 600;
      text-decoration: none;
      transition: color 0.3s ease;
    }
    body.dark a {
      color: var(--dark-red-dark);
    }
    a:hover, a:focus {
      text-decoration: underline;
    }
    .highlight-red {
      color: var(--highlight-red);
      font-weight: 700;
    }
    /* MOBILE RESPONSIVE STYLES */
    @media (max-width: 600px) {
      body {
        padding: 0.5rem;
        margin: 0.5rem;
      }
      h1 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
      }
      select, button, #searchInput {
        font-size: 0.9rem;
        padding: 0.5rem;
      }
      #preview {
        font-size: 0.75rem;
        max-height: 60px;
        margin-bottom: 0.4rem;
        padding-bottom: 0.25rem;
      }
      #content {
        font-size: 0.9rem;
        min-height: 180px;
        max-height: 300px;
        padding: 0.8rem 1rem 1rem 1rem;
      }
      img.thumb {
        max-height: 120px;
      }
    }
    /* Bookmark modal overlay */
    #bookmarkModalOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #bookmarkModalOverlay.active {
      display: flex;
    }
    #bookmarkModal {
      background-color: var(--background);
      color: var(--text-color);
      padding: 1rem 1.5rem;
      border-radius: 10px;
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 0 10px #0008;
      position: relative;
      font-size: 0.9rem;
    }
    body.dark #bookmarkModal {
      background-color: #222;
      color: var(--txt-dark);
      box-shadow: 0 0 20px #000f;
    }
    #bookmarkModal h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--dark-red);
    }
    #bookmarkCloseBtn {
      position: absolute;
      top: 0.3rem;
      right: 0.5rem;
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: var(--dark-red);
      cursor: pointer;
      font-weight: 700;
      transition: color 0.3s ease;
    }
    #bookmarkCloseBtn:hover {
      color: var(--mustard);
    }
    #bookmarkList .bookmarkCard {
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--sage);
    }
    body.dark #bookmarkList .bookmarkCard {
      border-color: var(--sage-dark);
    }
    #bookmarkList .bookmarkCard h4 {
      margin: 0 0 0.3rem 0;
      font-weight: 700;
      font-size: 1rem;
      color: var(--dark-red);
    }
  </style>
</head>
<body>

<h1>UGC NET English Literature Flash Info</h1>

<label for="moduleSelect">Select Module</label>
<select id="moduleSelect" aria-label="Select Module">
  <option value="">-- Loading modules... --</option>
</select>

<label for="chapterSelect">Select Chapter</label>
<select id="chapterSelect" disabled aria-label="Select Chapter">
  <option value="">-- Select module first --</option>
</select>

<label for="searchInput">Search Flash Info</label>
<input type="search" id="searchInput" placeholder="Search keywords, author, works..." aria-label="Search flash info" autocomplete="off" />

<div id="preview" aria-live="polite">Select module and chapter to see keyword info source.</div>
<div id="content" role="region" aria-label="Flash information content" tabindex="0">Please select a module and chapter to view info.</div>

<button id="nextBtn" disabled aria-label="Show another random info">Show Another Random Info</button>

<button id="bookmarkToggleBtn" aria-label="View bookmarked flash info">Bookmarks</button>

<!-- Bookmark modal -->
<div id="bookmarkModalOverlay" role="dialog" aria-modal="true" aria-labelledby="bookmarkModalTitle">
  <div id="bookmarkModal">
    <button id="bookmarkCloseBtn" aria-label="Close bookmarks modal">&times;</button>
    <h3 id="bookmarkModalTitle">Bookmarked Flash Info</h3>
    <div id="bookmarkList"></div>
  </div>
</div>

<button id="themeToggleBtn" aria-label="Toggle light/dark mode" style="margin-top:1em; padding:0.5em 1em;">Toggle Dark Mode</button>

<script>
  const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7cWnraaDNjm3MW4tUeVrVftj6iEBYwNkGZ7WsJsQfte3rbRhr1AF43fbIyVe1-ZMtvRVZgDrwusrT/pub?output=csv';

  const moduleSelect = document.getElementById('moduleSelect');
  const chapterSelect = document.getElementById('chapterSelect');
  const searchInput = document.getElementById('searchInput');
  const contentDiv = document.getElementById('content');
  const previewDiv = document.getElementById('preview');
  const nextBtn = document.getElementById('nextBtn');
  const bookmarkToggleBtn = document.getElementById('bookmarkToggleBtn');
  const bookmarkModalOverlay = document.getElementById('bookmarkModalOverlay');
  const bookmarkCloseBtn = document.getElementById('bookmarkCloseBtn');
  const bookmarkList = document.getElementById('bookmarkList');
  const themeToggleBtn = document.getElementById('themeToggleBtn');

  let dataRows = [];
  let filteredRows = [];
  let lastIndex = -1;
  const shownKeywords = new Set();

  let chapterKeywordsMap = {};

  // Bookmarks: store in localStorage under this key
  const BOOKMARKS_STORAGE_KEY = 'ugcnet_flash_bookmarks';

  // Theme: store in localStorage under this key
  const THEME_STORAGE_KEY = 'ugcnet_flash_theme';

  // -------------------- Utility functions -----------------------

  function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  function highlightKeyword(text, keyword) {
    const regex = new RegExp(`(${escapeRegex(keyword)})`, 'gi');
    return text.replace(regex, '<span class="highlight-red">$1</span>');
  }

  function cleanAuthorName(name) {
    if (!name) return '';
    return name.trim().replace(/\s*\([\d– -]+\)\s*$/, '');
  }

  function isAnonymousAuthor(name) {
    if (!name) return false;
    return /^anonymous(\s*\(\d+\))?$/i.test(name.trim());
  }

  function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    return lines.slice(1).map(line => {
      const cols = line.split(',').map(c => c.trim());
      let obj = {};
      headers.forEach((h, i) => {
        obj[h] = cols[i] || '';
      });
      return obj;
    });
  }

  function uniqueArray(arr) {
    return [...new Set(arr.filter(s => s && s.length > 0))];
  }

  // Build chapter-level Important Keywords map scanning all rows
  function buildChapterKeywordsMap(dataRows) {
    const map = {};
    dataRows.forEach(row => {
      const key = `${row.Module}|${row.Chapters}`;
      if (row["Important Keywords"] && row["Important Keywords"].trim() !== "" && !map[key]) {
        map[key] = row["Important Keywords"];
      }
    });
    return map;
  }

  // Compose keyword list: chapter keywords + author name + works keywords
  function composeKeywordList(row) {
    const key = `${row.Module}|${row.Chapters}`;
    const chapterKw = chapterKeywordsMap[key]
      ? chapterKeywordsMap[key].split(';').map(s => s.trim()).filter(s => s.length > 0)
      : [];
    const worksKw = row.Works ? parseKeywords(row.Works) : [];
    const cleanedAuthor = cleanAuthorName(row.AuthorName);
    const authorName = isAnonymousAuthor(cleanedAuthor) || !cleanedAuthor ? [] : [cleanedAuthor];
    const combined = [...chapterKw, ...authorName, ...worksKw];
    return uniqueArray(combined);
  }

  // Fetch Wikipedia extract with fallback for apostrophes
  async function fetchWikipediaExtract(title) {
    if (!title) return null;
    const url = `https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*&prop=extracts&exintro&explaintext&titles=${encodeURIComponent(title)}`;
    try {
      const response = await fetch(url);
      const data = await response.json();
      const pages = data.query.pages;
      const pageId = Object.keys(pages)[0];
      if (pageId === "-1") return null;
      const extract = pages[pageId].extract || null;
      if (extract) return extract;

      // Fallback: try without apostrophe
      const altTitle = title.replace(/’|'/g, '').trim();
      if (altTitle !== title) {
        const altUrl = `https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*&prop=extracts&exintro&explaintext&titles=${encodeURIComponent(altTitle)}`;
        const altResponse = await fetch(altUrl);
        const altData = await altResponse.json();
        const altPages = altData.query.pages;
        const altPageId = Object.keys(altPages)[0];
        if (altPageId === "-1") return null;
        return altPages[altPageId].extract || null;
      }

      return null;
    } catch {
      return null;
    }
  }

  // ---------------- Bookmarking -------------------

  function getBookmarks() {
    try {
      const saved = localStorage.getItem(BOOKMARKS_STORAGE_KEY);
      return saved ? JSON.parse(saved) : [];
    } catch {
      return [];
    }
  }

  function saveBookmarks(bookmarks) {
    localStorage.setItem(BOOKMARKS_STORAGE_KEY, JSON.stringify(bookmarks));
  }

  function isBookmarked(id, keyword) {
    const bookmarks = getBookmarks();
    return bookmarks.some(b => b.id === id && b.keyword === keyword);
  }

  function toggleBookmark(id, keyword, row, extract) {
    let bookmarks = getBookmarks();
    const index = bookmarks.findIndex(b => b.id === id && b.keyword === keyword);
    if (index >= 0) {
      bookmarks.splice(index, 1); // remove bookmark
    } else {
      bookmarks.push({ id, keyword, row, extract });
    }
    saveBookmarks(bookmarks);
  }

  function renderBookmarks() {
    const bookmarks = getBookmarks();
    bookmarkList.innerHTML = '';
    if (bookmarks.length === 0) {
      bookmarkList.innerHTML = '<p>No bookmarks yet.</p>';
      return;
    }
    bookmarks.forEach(b => {
      const card = document.createElement('div');
      card.className = 'bookmarkCard';
      card.innerHTML = `<h4>${b.keyword}</h4>
        <p><strong>Author:</strong> ${b.row.AuthorName || 'N/A'}</p>
        <p><strong>Important Keywords:</strong> ${chapterKeywordsMap[`${b.row.Module}|${b.row.Chapters}`] || 'N/A'}</p>
        <p><strong>Works:</strong> ${b.row.Works || 'N/A'}</p>
        <p>${b.extract}</p>`;
      bookmarkList.appendChild(card);
    });
  }

  bookmarkToggleBtn.addEventListener('click', () => {
    renderBookmarks();
    bookmarkModalOverlay.classList.add('active');
    bookmarkCloseBtn.focus();
  });

  bookmarkCloseBtn.addEventListener('click', () => {
    bookmarkModalOverlay.classList.remove('active');
    nextBtn.focus();
  });

  bookmarkModalOverlay.addEventListener('click', e => {
    if (e.target === bookmarkModalOverlay) {
      bookmarkModalOverlay.classList.remove('active');
      nextBtn.focus();
    }
  });

  // ---------------- Theme Handling ----------------

  function applyTheme(theme) {
    if (theme === 'dark') {
      document.body.classList.add('dark');
      themeToggleBtn.textContent = 'Toggle Light Mode';
    } else {
      document.body.classList.remove('dark');
      themeToggleBtn.textContent = 'Toggle Dark Mode';
    }
    localStorage.setItem(THEME_STORAGE_KEY, theme);
  }

  themeToggleBtn.addEventListener('click', () => {
    const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
    applyTheme(newTheme);
  });

  // Initialize theme from localStorage
  const savedTheme = localStorage.getItem(THEME_STORAGE_KEY) || 'light';
  applyTheme(savedTheme);

  // ------------------ Main Logic -------------------

  function filterRowsBySearch(rows, searchTerm) {
    if (!searchTerm) return rows;
    const lower = searchTerm.toLowerCase();
    return rows.filter(row => {
      return (
        (row.AuthorName && row.AuthorName.toLowerCase().includes(lower)) ||
        (row.Works && row.Works.toLowerCase().includes(lower)) ||
        (chapterKeywordsMap[`${row.Module}|${row.Chapters}`] &&
          chapterKeywordsMap[`${row.Module}|${row.Chapters}`].toLowerCase().includes(lower))
      );
    });
  }

  async function showFlashCard(row, keyword, extract) {
    previewDiv.innerHTML = highlightKeyword(
      `AuthorName: ${row.AuthorName || 'N/A'}; Important Keywords: ${chapterKeywordsMap[`${row.Module}|${row.Chapters}`] || 'N/A'}; Works: ${row.Works || 'N/A'}`,
      keyword
    );
    contentDiv.innerHTML = `
      <img src="${row.ImageURL}" alt="${row.AuthorName || 'Image'}" class="thumb" />
      <h2>${keyword}</h2>
      <p>${extract}</p>
      <p><a href="https://en.wikipedia.org/wiki/${encodeURIComponent(keyword)}" target="_blank" rel="noopener noreferrer">Read more on Wikipedia</a></p>
      <button id="bookmarkBtn" aria-label="Toggle bookmark for this flash info">${isBookmarked(row.ID, keyword) ? 'Remove Bookmark' : 'Add Bookmark'}</button>
    `;

    document.getElementById('bookmarkBtn').addEventListener('click', () => {
      toggleBookmark(row.ID, keyword, row, extract);
      renderBookmarks();
      // Update button label
      document.getElementById('bookmarkBtn').textContent = isBookmarked(row.ID, keyword) ? 'Remove Bookmark' : 'Add Bookmark';
    });
  }

  async function showRandomInfo() {
    if (filteredRows.length === 0) {
      previewDiv.textContent = "";
      contentDiv.textContent = "No data for selected module and chapter.";
      nextBtn.disabled = true;
      return;
    }

    let tries = 0;
    let idx;
    do {
      idx = Math.floor(Math.random() * filteredRows.length);
      tries++;
      if (tries > 50) {
        previewDiv.textContent = "";
        contentDiv.textContent = "No new unique information available for the current filter.";
        nextBtn.disabled = true;
        return;
      }
    } while (idx === lastIndex && filteredRows.length > 1);

    lastIndex = idx;
    const row = filteredRows[idx];
    const candidates = composeKeywordList(row).filter(kw => !shownKeywords.has(kw));

    if (candidates.length === 0) {
      // Try other rows for unseen keywords
      for (let attempt = 0; attempt < filteredRows.length; attempt++) {
        let testRow = filteredRows[(idx + attempt) % filteredRows.length];
        const testKw = composeKeywordList(testRow).filter(kw => !shownKeywords.has(kw));
        if (testKw.length > 0) {
          idx = (idx + attempt) % filteredRows.length;
          lastIndex = idx;
          filteredRows[idx] = testRow;
          candidates.splice(0, candidates.length, ...testKw);
          break;
        }
      }
      if (candidates.length === 0) {
        previewDiv.textContent = "";
        contentDiv.textContent = "No new unique information left for the current filter.";
        nextBtn.disabled = true;
        return;
      }
    }

    previewDiv.innerHTML = highlightKeyword(
      `AuthorName: ${row.AuthorName || 'N/A'}; Important Keywords: ${chapterKeywordsMap[`${row.Module}|${row.Chapters}`] || 'N/A'}; Works: ${row.Works || 'N/A'}`,
      candidates[0]
    );

    contentDiv.textContent = "Loading Wikipedia data...";

    let successKeyword = null;
    let extract = null;
    for (const kw of candidates) {
      extract = await fetchWikipediaExtract(kw);
      if (extract) {
        successKeyword = kw;
        shownKeywords.add(kw);
        break;
      } else {
        shownKeywords.add(kw);
      }
    }

    if (successKeyword && extract) {
      showFlashCard(row, successKeyword, extract);
      nextBtn.disabled = false;
    } else {
      contentDiv.textContent = "No Wikipedia extract found for available keywords.";
      nextBtn.disabled = false;
    }
  }

  moduleSelect.addEventListener('change', () => {
    shownKeywords.clear();
    const mod = moduleSelect.value;
    populateChapters(mod);
    previewDiv.textContent = "Select chapter to see keyword info source.";
    contentDiv.textContent = "Please select a chapter to view info.";
    nextBtn.disabled = true;
    filteredRows = [];
    lastIndex = -1;
    searchInput.value = '';
  });

  chapterSelect.addEventListener('change', () => {
    shownKeywords.clear();
    const mod = moduleSelect.value;
    const chap = chapterSelect.value;
    if (mod && chap) {
      filteredRows = dataRows.filter(r => r.Module === mod && r.Chapters === chap);
      previewDiv.textContent = "";
      contentDiv.textContent = "Ready. Click 'Show Another Random Info' or use search.";
      nextBtn.disabled = filteredRows.length === 0;
      lastIndex = -1;
      searchInput.value = '';
    } else {
      filteredRows = [];
      previewDiv.textContent = "";
      contentDiv.textContent = "Please select a module and chapter to view info.";
      nextBtn.disabled = true;
      lastIndex = -1;
      searchInput.value = '';
    }
  });

  // Search input filtering
  searchInput.addEventListener('input', () => {
    const searchTerm = searchInput.value.trim().toLowerCase();
    if (!searchTerm) {
      // reset filter to current chapter module combo
      if (moduleSelect.value && chapterSelect.value) {
        filteredRows = dataRows.filter(r => r.Module === moduleSelect.value && r.Chapters === chapterSelect.value);
        nextBtn.disabled = filteredRows.length === 0;
        previewDiv.textContent = '';
        contentDiv.textContent = "Ready. Click 'Show Another Random Info' or use search.";
        lastIndex = -1;
      }
      shownKeywords.clear();
      return;
    }
    filteredRows = dataRows.filter(r => {
      if (moduleSelect.value && chapterSelect.value && (r.Module !== moduleSelect.value || r.Chapters !== chapterSelect.value)) return false;
      const key = `${r.Module}|${r.Chapters}`;
      const chapKeywords = chapterKeywordsMap[key] ? chapterKeywordsMap[key].toLowerCase() : '';
      return (
        (r.AuthorName && r.AuthorName.toLowerCase().includes(searchTerm)) ||
        (r.Works && r.Works.toLowerCase().includes(searchTerm)) ||
        chapKeywords.includes(searchTerm)
      );
    });
    nextBtn.disabled = filteredRows.length === 0;
    previewDiv.textContent = '';
    contentDiv.textContent = filteredRows.length === 0 ? 'No results found for your search.' : 'Filtered results available. Click Show Another Random Info.';
    lastIndex = -1;
    shownKeywords.clear();
  });

  nextBtn.addEventListener('click', showRandomInfo);

  // CSV load and map build
  fetch(csvUrl)
    .then(res => res.text())
    .then(text => {
      dataRows = parseCSV(text);
      chapterKeywordsMap = buildChapterKeywordsMap(dataRows);
      populateModules();
    })
    .catch(() => {
      previewDiv.textContent = "";
      contentDiv.textContent = "Failed to load data.";
      moduleSelect.innerHTML = '<option>Error loading data</option>';
      chapterSelect.innerHTML = '<option>Error loading data</option>';
      nextBtn.disabled = true;
    });
</script>

</body>
</html>
