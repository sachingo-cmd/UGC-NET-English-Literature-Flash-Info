<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UGC NET English Literature Flash Info</title>
  <style>
    :root {
      --dark-red: #b8483c;
      --mustard: #b8a245;
      --charcoal: #3c393e;
      --sage: #a6bd9e;
      --brown: #9c705d;
      --background: #f8f7f3;
      --text-color: #333333;
      --button-text-light: #ffffff;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 1rem auto;
      background-color: var(--background);
      color: var(--text-color);
      padding: 1rem;
    }
    h1 {
      color: var(--dark-red);
      font-weight: bold;
      text-align: center;
      margin-bottom: 1rem;
      text-shadow: 1px 1px 2px rgba(200, 200, 200, 0.6);
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--mustard);
      user-select: none;
    }
    select, button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: 2px solid var(--sage);
      border-radius: 6px;
      margin: 0.5rem 0 1rem 0;
      outline: none;
      font-weight: 600;
      user-select: none;
      width: 100%;
      box-sizing: border-box;
      cursor: pointer;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    select {
      background-color: #fff;
      color: var(--text-color);
      cursor: pointer;
    }
    select:focus {
      border-color: var(--mustard);
      box-shadow: 0 0 5px var(--mustard);
    }
    button {
      background-color: var(--mustard);
      color: var(--button-text-light);
      border-color: var(--mustard);
    }
    button:disabled {
      background-color: #ccc;
      border-color: #ccc;
      cursor: not-allowed;
      color: #666;
    }
    button:hover:not(:disabled) {
      background-color: var(--dark-red);
      border-color: var(--dark-red);
    }
    #content {
      background-color: var(--sage);
      border-radius: 8px;
      padding: 1rem 1.5rem 1.5rem 1.5rem;
      min-height: 250px;
      line-height: 1.5;
      color: var(--charcoal);
      font-size: 1rem;
      box-shadow: 0 4px 8px rgba(60, 57, 62, 0.15);
      overflow-y: auto;
      max-height: 500px;
      user-select: text;
      position: relative;
    }
    h2 {
      color: var(--dark-red);
      margin-top: 0;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }
    p {
      margin-bottom: 1rem;
      white-space: pre-wrap;
    }
    img.thumb {
      max-height: 150px;
      display: block;
      margin: 0.25rem 0 1.0rem 0;
      border-radius: 6px;
      border: 1px solid var(--brown);
      box-shadow: 1px 1px 4px #8884;
    }
    a {
      color: var(--dark-red);
      font-weight: 600;
      text-decoration: none;
    }
    a:hover, a:focus {
      text-decoration: underline;
    }
  </style>
</head>
<body>

<h1>UGC NET English Literature Flash Info</h1>

<label for="moduleSelect">Select Module</label>
<select id="moduleSelect">
  <option value="">-- Loading modules... --</option>
</select>

<label for="chapterSelect">Select Chapter</label>
<select id="chapterSelect" disabled>
  <option value="">-- Select module first --</option>
</select>

<div id="content">Please select a module and chapter to view info.</div>
<button id="nextBtn" disabled>Show Another Random Info</button>

<script>
  // CSV URL with output=csv for actual csv content
  const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7cWnraaDNjm3MW4tUeVrVftj6iEBYwNkGZ7WsJsQfte3rbRhr1AF43fbIyVe1-ZMtvRVZgDrwusrT/pub?output=csv';

  const moduleSelect = document.getElementById('moduleSelect');
  const chapterSelect = document.getElementById('chapterSelect');
  const contentDiv = document.getElementById('content');
  const nextBtn = document.getElementById('nextBtn');

  let dataRows = [];
  let filteredRows = [];
  let lastIndex = -1;

  // CSV parser, simple split by commas assuming no commas inside fields; update if needed for quotes
  function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    return lines.slice(1).map(line => {
      const cols = line.split(',').map(c => c.trim());
      let obj = {};
      headers.forEach((h, i) => {
        obj[h] = cols[i] || '';
      });
      return obj;
    });
  }

  // Extract unique items from array
  function uniqueArray(arr) {
    return [...new Set(arr.filter(s => s && s.length > 0))];
  }

  // Populate Module dropdown with unique modules
  function populateModules() {
    const modules = uniqueArray(dataRows.map(r => r.Module));
    moduleSelect.innerHTML = '<option value="">-- Select Module --</option>';
    modules.forEach(mod => {
      moduleSelect.innerHTML += `<option value="${mod}">${mod}</option>`;
    });
    chapterSelect.innerHTML = `<option value="">-- Select Module first --</option>`;
    chapterSelect.disabled = true;
    nextBtn.disabled = true;
    contentDiv.textContent = "Please select a module and chapter to view info.";
  }

  // Populate Chapters dropdown filtered by selected module
  function populateChapters(moduleName) {
    if (!moduleName) {
      chapterSelect.innerHTML = `<option value="">-- Select Module first --</option>`;
      chapterSelect.disabled = true;
      nextBtn.disabled = true;
      contentDiv.textContent = "Please select a module and chapter to view info.";
      return;
    }
    const chapters = uniqueArray(dataRows.filter(r => r.Module === moduleName).map(r => r.Chapters));
    chapterSelect.innerHTML = `<option value="">-- Select Chapter --</option>`;
    chapters.forEach(chap => {
      chapterSelect.innerHTML += `<option value="${chap}">${chap}</option>`;
    });
    chapterSelect.disabled = false;
    nextBtn.disabled = true;
    contentDiv.textContent = "Please select a chapter to view info.";
  }

  // Clean keywords: split by semicolon, trim, remove years in parentheses
  function parseKeywords(str) {
    if (!str) return [];
    return str
      .split(';')
      .map(s => s.trim().replace(/\(\d+\)/g, ''))
      .filter(s => s.length > 0);
  }

  // Compose keywords from AuthorName, Important Keywords, Works columns
  function composeKeywordList(row) {
    const list = [];
    if (row.AuthorName) list.push(row.AuthorName.trim());
    if (row['Important Keywords']) {
      list.push(...parseKeywords(row['Important Keywords']));
    }
    if (row.Works) {
      list.push(...parseKeywords(row.Works));
    }
    // Deduplicate list
    return uniqueArray(list);
  }

  // Fetch Wikipedia extract for given title
  async function fetchWikipediaExtract(title) {
    if (!title) return null;
    const url = `https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*&prop=extracts&exintro&explaintext&titles=${encodeURIComponent(title)}`;
    try {
      const response = await fetch(url);
      const data = await response.json();
      const pages = data.query.pages;
      const pageId = Object.keys(pages)[0];
      if (pageId === "-1") return null;
      return pages[pageId].extract || null;
    } catch {
      return null;
    }
  }

  // Show random flash info for filtered rows in selected chapter
  async function showRandomInfo() {
    if (filteredRows.length === 0) {
      contentDiv.textContent = "No data for selected module and chapter.";
      nextBtn.disabled = true;
      return;
    }
    let idx;
    if (filteredRows.length === 1) {
      idx = 0;
    } else {
      do {
        idx = Math.floor(Math.random() * filteredRows.length);
      } while (idx === lastIndex);
    }
    lastIndex = idx;
    const row = filteredRows[idx];

    const keywords = composeKeywordList(row);
    if (keywords.length === 0) {
      contentDiv.textContent = "No keywords found for the selected entry.";
      return;
    }
    contentDiv.textContent = "Loading Wikipedia data...";
    // Try fetching extracts from keywords, stop at first success
    for (const kw of keywords) {
      const extract = await fetchWikipediaExtract(kw);
      if (extract) {
        contentDiv.innerHTML = `
          <img src="${row.ImageURL}" alt="${row.AuthorName}" class="thumb" />
          <h2>${kw}</h2>
          <p>${extract}</p>
          <p><a href="https://en.wikipedia.org/wiki/${encodeURIComponent(kw)}" target="_blank" rel="noopener noreferrer">Read more on Wikipedia</a></p>`;
        nextBtn.disabled = false;
        return;
      }
    }
    contentDiv.textContent = "No Wikipedia extract found for keywords.";
    nextBtn.disabled = false;
  }

  // EVENT LISTENERS

  // Module select changed
  moduleSelect.addEventListener('change', () => {
    const mod = moduleSelect.value;
    populateChapters(mod);
    contentDiv.textContent = "Please select a chapter to view info.";
    nextBtn.disabled = true;
    filteredRows = [];
    lastIndex = -1;
  });

  // Chapter select changed
  chapterSelect.addEventListener('change', () => {
    const module = moduleSelect.value;
    const chapter = chapterSelect.value;
    if (module && chapter) {
      filteredRows = dataRows.filter(r => r.Module === module && r.Chapters === chapter);
      contentDiv.textContent = "Ready to show flash info. Click 'Show Another Random Info'.";
      nextBtn.disabled = filteredRows.length === 0;
      lastIndex = -1;
    } else {
      filteredRows = [];
      contentDiv.textContent = "Please select a module and chapter to view info.";
      nextBtn.disabled = true;
      lastIndex = -1;
    }
  });

  // Next button clicked to show random info
  nextBtn.addEventListener('click', () => {
    showRandomInfo();
  });

  // FETCH CSV AND INITIALIZE
  fetch(csvUrl)
    .then(r => r.text())
    .then(text => {
      dataRows = parseCSV(text);
      populateModules();
    })
    .catch(() => {
      contentDiv.textContent = "Failed to load syllabus data.";
      moduleSelect.innerHTML = '<option>Error loading data</option>';
      chapterSelect.innerHTML = '<option>Error loading data</option>';
      nextBtn.disabled = true;
    });

</script>

</body>
</html>
