<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UGC NET English Literature Flash Info</title>
  <style>
    :root {
      --dark-red: #b8483c;
      --mustard: #b8a245;
      --charcoal: #3c393e;
      --sage: #a6bd9e;
      --brown: #9c705d;
      --background: #f8f7f3;
      --text-color: #333333;
      --button-text-light: #ffffff;
      --highlight-red: #d22;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 1rem auto;
      background-color: var(--background);
      color: var(--text-color);
      padding: 1rem;
    }
    h1 {
      color: var(--dark-red);
      font-weight: bold;
      text-align: center;
      margin-bottom: 1rem;
      text-shadow: 1px 1px 2px rgba(200, 200, 200, 0.6);
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--mustard);
      user-select: none;
    }
    select, button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: 2px solid var(--sage);
      border-radius: 6px;
      margin: 0.5rem 0 1rem 0;
      outline: none;
      font-weight: 600;
      user-select: none;
      width: 100%;
      box-sizing: border-box;
      cursor: pointer;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    select {
      background-color: #fff;
      color: var(--text-color);
      cursor: pointer;
    }
    select:focus {
      border-color: var(--mustard);
      box-shadow: 0 0 5px var(--mustard);
    }
    button {
      background-color: var(--mustard);
      color: var(--button-text-light);
      border-color: var(--mustard);
    }
    button:disabled {
      background-color: #ccc;
      border-color: #ccc;
      cursor: not-allowed;
      color: #666;
    }
    button:hover:not(:disabled) {
      background-color: var(--dark-red);
      border-color: var(--dark-red);
    }
    #preview {
      font-size: 0.85rem;
      color: #555;
      border-bottom: 1px solid var(--sage);
      margin-bottom: 0.6rem;
      padding-bottom: 0.3rem;
      font-family: monospace, monospace;
      white-space: pre-wrap;
      user-select: text;
      max-height: 70px;
      overflow: auto;
    }
    #content {
      background-color: var(--sage);
      border-radius: 8px;
      padding: 1rem 1.5rem 1.5rem 1.5rem;
      min-height: 250px;
      line-height: 1.5;
      color: var(--charcoal);
      font-size: 1rem;
      box-shadow: 0 4px 8px rgba(60, 57, 62, 0.15);
      overflow-y: auto;
      max-height: 430px;
      user-select: text;
      position: relative;
    }
    h2 {
      color: var(--dark-red);
      margin-top: 0;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }
    p {
      margin-bottom: 1rem;
      white-space: pre-wrap;
    }
    img.thumb {
      max-height: 150px;
      display: block;
      margin: 0.25rem 0 1.0rem 0;
      border-radius: 6px;
      border: 1px solid var(--brown);
      box-shadow: 1px 1px 4px #8884;
      max-width: 100%;
      height: auto;
    }
    a {
      color: var(--dark-red);
      font-weight: 600;
      text-decoration: none;
    }
    a:hover, a:focus {
      text-decoration: underline;
    }
    .highlight-red {
      color: var(--highlight-red);
      font-weight: 700;
    }
  </style>
</head>
<body>

<h1>UGC NET English Literature Flash Info</h1>

<label for="moduleSelect">Select Module</label>
<select id="moduleSelect">
  <option value="">-- Loading modules... --</option>
</select>

<label for="chapterSelect">Select Chapter</label>
<select id="chapterSelect" disabled>
  <option value="">-- Select module first --</option>
</select>

<div id="preview">Select module and chapter to see keyword info source.</div>
<div id="content">Please select a module and chapter to view info.</div>
<button id="nextBtn" disabled>Show Another Random Info</button>

<script>
  const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7cWnraaDNjm3MW4tUeVrVftj6iEBYwNkGZ7WsJsQfte3rbRhr1AF43fbIyVe1-ZMtvRVZgDrwusrT/pub?output=csv';

  const moduleSelect = document.getElementById('moduleSelect');
  const chapterSelect = document.getElementById('chapterSelect');
  const contentDiv = document.getElementById('content');
  const previewDiv = document.getElementById('preview');
  const nextBtn = document.getElementById('nextBtn');

  let dataRows = [];
  let filteredRows = [];
  let lastIndex = -1;
  const shownKeywords = new Set();

  // This will be built at load from your CSV!
  let chapterKeywordsMap = {};

  function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  function highlightKeyword(text, keyword) {
    const regex = new RegExp(`(${escapeRegex(keyword)})`, 'gi');
    return text.replace(regex, '<span class="highlight-red">$1</span>');
  }

  // Remove trailing parentheses containing digits or dashes from author names
  function cleanAuthorName(name) {
    if (!name) return '';
    return name.trim().replace(/\s*\([\dâ€“ -]+\)\s*$/, '');
  }

  // Exclude authors named anonymous (alone or with year)
  function isAnonymousAuthor(name) {
    if (!name) return false;
    return /^anonymous(\s*\(\d+\))?$/i.test(name.trim());
  }

  function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    return lines.slice(1).map(line => {
      const cols = line.split(',').map(c => c.trim());
      let obj = {};
      headers.forEach((h, i) => {
        obj[h] = cols[i] || '';
      });
      return obj;
    });
  }

  function uniqueArray(arr) {
    return [...new Set(arr.filter(s => s && s.length > 0))];
  }

  // Build chapter-level Important Keywords map scanning all rows
  function buildChapterKeywordsMap(dataRows) {
    const map = {};
    dataRows.forEach(row => {
      const key = `${row.Module}|${row.Chapters}`;
      if (row["Important Keywords"] && row["Important Keywords"].trim() !== "" && !map[key]) {
        map[key] = row["Important Keywords"];
      }
    });
    return map;
  }

  function populateModules() {
    const modules = uniqueArray(dataRows.map(r => r.Module));
    moduleSelect.innerHTML = '<option value="">-- Select Module --</option>';
    modules.forEach(mod => {
      moduleSelect.innerHTML += `<option value="${mod}">${mod}</option>`;
    });
    chapterSelect.innerHTML = `<option value="">-- Select Module first --</option>`;
    chapterSelect.disabled = true;
    nextBtn.disabled = true;
    previewDiv.textContent = "Select module and chapter to see keyword info source.";
    contentDiv.textContent = "Please select a module and chapter to view info.";
  }

  function populateChapters(moduleName) {
    if (!moduleName) {
      chapterSelect.innerHTML = `<option value="">-- Select Module first --</option>`;
      chapterSelect.disabled = true;
      nextBtn.disabled = true;
      previewDiv.textContent = "Select module and chapter to see keyword info source.";
      contentDiv.textContent = "Please select a module and chapter to view info.";
      return;
    }
    const chapters = uniqueArray(dataRows.filter(r => r.Module === moduleName).map(r => r.Chapters));
    chapterSelect.innerHTML = `<option value="">-- Select Chapter --</option>`;
    chapters.forEach(chap => {
      chapterSelect.innerHTML += `<option value="${chap}">${chap}</option>`;
    });
    chapterSelect.disabled = false;
    nextBtn.disabled = true;
    previewDiv.textContent = "Select chapter to see keyword info source.";
    contentDiv.textContent = "Please select a chapter to view info.";
  }

  // Only remove parentheses containing digits (years), preserve others like (poem)
  // Trim spaces from works keywords
  function parseKeywords(str) {
    if (!str) return [];
    return str
      .split(';')
      .map(s => s.trim().replace(/\(\d+\)/g, ''))
      .filter(s => s.length > 0);
  }

  // Compose keyword list: chapter keywords (from the map) + cleaned author name (if not anonymous) + works keywords
  function composeKeywordList(row) {
    const key = `${row.Module}|${row.Chapters}`;
    // Use chapter-level important keywords, if present in map
    const chapterKw = chapterKeywordsMap[key]
      ? chapterKeywordsMap[key].split(';').map(s => s.trim()).filter(s => s.length > 0)
      : [];
    const worksKw = row.Works ? parseKeywords(row.Works) : [];
    const cleanedAuthor = cleanAuthorName(row.AuthorName);
    const authorName = isAnonymousAuthor(cleanedAuthor) || !cleanedAuthor ? [] : [cleanedAuthor];
    const combined = [...chapterKw, ...authorName, ...worksKw];
    return uniqueArray(combined);
  }

  async function fetchWikipediaExtract(title) {
    if (!title) return null;
    const url = `https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*&prop=extracts&exintro&explaintext&titles=${encodeURIComponent(title)}`;
    try {
      const response = await fetch(url);
      const data = await response.json();
      const pages = data.query.pages;
      const pageId = Object.keys(pages)[0];
      if (pageId === "-1") return null;
      return pages[pageId].extract || null;
    } catch {
      return null;
    }
  }

  async function showRandomInfo() {
    if (filteredRows.length === 0) {
      previewDiv.textContent = "";
      contentDiv.textContent = "No data for selected module and chapter.";
      nextBtn.disabled = true;
      return;
    }
    
    let tries = 0;
    let idx;
    do {
      idx = Math.floor(Math.random() * filteredRows.length);
      tries++;
      if (tries > 20) {
        previewDiv.textContent = "";
        contentDiv.textContent = "No new unique information available for today.";
        nextBtn.disabled = true;
        return;
      }
    } while (idx === lastIndex && filteredRows.length > 1);

    lastIndex = idx;
    const row = filteredRows[idx];
    const candidates = composeKeywordList(row).filter(kw => !shownKeywords.has(kw));

    if (candidates.length === 0) {
      for (let attempt = 0; attempt < filteredRows.length; attempt++) {
        let testRow = filteredRows[(idx + attempt) % filteredRows.length];
        const testKw = composeKeywordList(testRow).filter(kw => !shownKeywords.has(kw));
        if (testKw.length > 0) {
          idx = (idx + attempt) % filteredRows.length;
          lastIndex = idx;
          filteredRows[idx] = testRow;
          candidates.splice(0, candidates.length, ...testKw);
          break;
        }
      }
      if (candidates.length === 0) {
        previewDiv.textContent = "";
        contentDiv.textContent = "No new unique information left for today in this chapter.";
        nextBtn.disabled = true;
        return;
      }
    }

    // Initially highlight first candidate keyword for diagnostics
    previewDiv.innerHTML = highlightKeyword(
      `AuthorName: ${row.AuthorName || 'N/A'}; Important Keywords: ${chapterKeywordsMap[`${row.Module}|${row.Chapters}`] || 'N/A'}; Works: ${row.Works || 'N/A'}`,
      candidates[0]
    );

    contentDiv.textContent = "Loading Wikipedia data...";
    let successKeyword = null;
    for (const kw of candidates) {
      const extract = await fetchWikipediaExtract(kw);
      if (extract) {
        successKeyword = kw;
        shownKeywords.add(kw);
        break;
      } else {
        shownKeywords.add(kw);
      }
    }

    if (successKeyword) {
      previewDiv.innerHTML = highlightKeyword(
        `AuthorName: ${row.AuthorName || 'N/A'}; Important Keywords: ${chapterKeywordsMap[`${row.Module}|${row.Chapters}`] || 'N/A'}; Works: ${row.Works || 'N/A'}`,
        successKeyword
      );
      contentDiv.innerHTML = `
        <img src="${row.ImageURL}" alt="${row.AuthorName || 'Image'}" class="thumb" />
        <h2>${successKeyword}</h2>
        <p>${await fetchWikipediaExtract(successKeyword)}</p>
        <p><a href="https://en.wikipedia.org/wiki/${encodeURIComponent(successKeyword)}" target="_blank">Read more on Wikipedia</a></p>`;
      nextBtn.disabled = false;
    } else {
      contentDiv.textContent = "No Wikipedia extract found for available keywords.";
      nextBtn.disabled = false;
    }
  }

  moduleSelect.addEventListener('change', () => {
    const mod = moduleSelect.value;
    populateChapters(mod);
    previewDiv.textContent = "Select chapter to see keyword info source.";
    contentDiv.textContent = "Please select a chapter to view info.";
    nextBtn.disabled = true;
    filteredRows = [];
    lastIndex = -1;
    shownKeywords.clear();
  });

  chapterSelect.addEventListener('change', () => {
    const mod = moduleSelect.value;
    const chap = chapterSelect.value;
    if (mod && chap) {
      filteredRows = dataRows.filter(r => r.Module === mod && r.Chapters === chap);
      previewDiv.textContent = "";
      contentDiv.textContent = "Ready. Click 'Show Another Random Info'.";
      nextBtn.disabled = filteredRows.length === 0;
      lastIndex = -1;
      shownKeywords.clear();
    } else {
      filteredRows = [];
      previewDiv.textContent = "";
      contentDiv.textContent = "Please select a module and chapter to view info.";
      nextBtn.disabled = true;
      lastIndex = -1;
      shownKeywords.clear();
    }
  });

  nextBtn.addEventListener('click', showRandomInfo);

  // CSV load and map build
  fetch(csvUrl)
    .then(res => res.text())
    .then(text => {
      dataRows = parseCSV(text);
      chapterKeywordsMap = buildChapterKeywordsMap(dataRows);
      populateModules();
    })
    .catch(() => {
      previewDiv.textContent = "";
      contentDiv.textContent = "Failed to load data.";
      moduleSelect.innerHTML = '<option>Error loading data</option>';
      chapterSelect.innerHTML = '<option>Error loading data</option>';
      nextBtn.disabled = true;
    });
</script>

</body>
</html>
